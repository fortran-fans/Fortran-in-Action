# ä½¿ç”¨ Lua è¯­è¨€åŠå…¶è„šæœ¬å®ç° Fortran ç¨‹åºçš„çƒ­é‡è½½

`fortran-lua53`ğŸ”¥ä»“åº“ (è®¸å¯è¯: ISCï¼Œç±»ä¼¼BSD-2): [https://github.com/interkosmos/fortran-lua53](https://github.com/interkosmos/fortran-lua53)

`fortran-lua`æ˜¯ [Philipp](https://github.com/interkosmos) ç¼–å†™çš„å¼€æºé¡¹ç›®ï¼Œå®ƒæ˜¯ Lua 5.3 çš„ Fortran æ¥å£ã€‚

<div align="center">
<img src="media/luaa.gif" alt="Lua" width="150">
</div>

## Lua ç®€ä»‹

Lua ç”± C è¯­è¨€ç¼–ç¨‹ï¼Œå¯ä»¥ä½œä¸ºå•ç‹¬çš„ Lua è§£é‡Šå™¨æˆ– C è¯­è¨€å‡½æ•°åº“ï¼Œæ˜¯ä¸€åä¼˜ç§€å°å·§çš„å‡½æ•°å¼åŠ¨æ€è¯­è¨€ï¼Œå…¶é€Ÿåº¦æ˜¯åŠ¨æ€è¯­è¨€ä¸­ Top 0 çº§åˆ«çš„ï¼Œå¦å¤–ï¼ŒLua è¯­è¨€æ˜¯ç½•è§çš„ç”±å‘å±•ä¸­å›½å®¶è®¾è®¡å¼€å‘å‡ºçš„è‘—åè¯­è¨€ã€‚

å®ƒçš„ä¸»è¦åº”ç”¨åœºæ™¯æ˜¯:

- ä¸ºç¼–è¯‘å‹è¯­è¨€å¸¦æ¥çµæ´»æ€§;
- ä¸ºç¼–è¯‘å‹è¯­è¨€ä»£ç å¯æ‹“å±•æ€§ï¼Œè¿™ä¸€ç‚¹ä½“ç°åœ¨çƒ­é‡è½½èƒ½åŠ›ã€‚

> ğŸ”° çƒ­é‡è½½: ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå½“ä¸å…·å¤‡ä»»ä½•åå°„ç‰¹æ€§çš„ç¼–è¯‘å‹è¯­è¨€ä¸€æ—¦å®Œæˆç¼–è¯‘ï¼Œå®ç°éƒ¨ç½²ï¼Œä¸­é€”å¦‚æœå‘ç° Bug ï¼Œåˆ™éœ€è¦é‡æ–°ä¿®æ”¹æºç ï¼Œå†è¿›è¡Œç¼–è¯‘éƒ¨ç½²ï¼Œä¸”éœ€è¦ä¸­æ–­ä¹‹å‰æ­£åœ¨è¿è¡Œçš„å« Bug çš„ç¨‹åºã€‚  
> ä½†æ˜¯ï¼Œé€šè¿‡ Lua è„šæœ¬ï¼Œæ¯”å¦‚ Fortran ï¼Œå¯ä»¥å€ŸåŠ© Lua åªå®ç° Lua è„šæœ¬çš„å†…å®¹ï¼Œå°±èƒ½ä¸€å®šç¨‹åº¦æ”¹å˜ç¨‹åºçš„åç»­è¿è¡Œè¿‡ç¨‹ï¼Œå¯ä»¥ä¸€å®šç¨‹åº¦é¿å…ä¸­æ–­è¿è¡Œã€‚  
> è¿™ç‚¹ä¸é…ç½®æ–‡ä»¶ä¼¼ä¹æœ‰ç€å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼Œä½†é…ç½®æ–‡ä»¶ä¸»è¦è´Ÿè´£ç¨‹åºæ•°æ®çš„é…ç½®ï¼Œè€Œ Lua è„šæœ¬åˆ™æ›´ä½“ç°å‡ºä»å‡½æ•°ï¼ˆæ–¹æ³•ï¼‰ä¸Šæ”¹å˜ç¨‹åºçš„è¿è¡Œä¸šåŠ¡ï¼Œä¸”æ›´çµæ´»ï¼Œæ•°æ®é…ç½®äº¦å¯ã€‚  
> æ‰€ä»¥ï¼ŒLua åœ¨æ¸¸æˆå¼€å‘è¡Œä¸šç”¨çš„è¾ƒå¤šï¼Œå¯ä»¥ä¸ºä¸Šçº¿çš„æ¸¸æˆå¿«é€Ÿæ¨é€ Lua è¡¥ä¸ï¼Œæ€§èƒ½åˆå¥½ï¼Œä½“ç§¯åˆå°ã€‚
> åœ¨ç§‘å­¦è®¡ç®—ä¸­ï¼Œå¦‚è®¡ç®—æµä½“åŠ›å­¦ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰luaè„šæœ¬å®ç°ç½‘æ ¼ã€ç²’å­çš„åˆå§‹åŒ–ï¼Œä»å†…å­˜ä¼ é€’ç»™æ ¸å¿ƒè®¡ç®—ç¨‹åºã€‚

## æ¼”ç¤º: ä½¿ç”¨ Lua è„šæœ¬æ”¹å˜ç¨‹åºçš„è¿è¡Œæ•ˆæœ

æˆ‘ä»¬æ¼”ç¤ºä¸€ä¸‹åœ¨ä»£ç ç¼–å†™è¿‡ç¨‹ä¸­å†™é”™äº† Lua ä¸šåŠ¡ï¼Œç„¶ååœ¨ä¸ä¿®æ”¹ Fortran ä»£ç ã€ä¸é‡æ–°ç¼–è¯‘ä»£ç ã€ä¸ä¸­æ–­ç¨‹åºè¿è¡Œçš„æƒ…å†µä¸‹ï¼Œå®ç° Lua ä¸šåŠ¡ä¿®æ”¹å’Œæ­£ç¡®è¿è¡Œï¼š

```sh
cd workspace  # åˆ‡æ¢åˆ°ä½ å¸¸ç”¨çš„å·¥ä½œåŒºé—´
fpm new --app lua-demo  # åˆ›å»ºfpmé¡¹ç›®
cd lua-demo && code .   # åˆ‡æ¢åˆ°`lua-demo`æ–‡ä»¶å¤¹ï¼Œå¹¶ä½¿ç”¨vs codeæ‰“å¼€å®ƒ
```

æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª`lua-demo`å·¥ç¨‹ï¼Œä½¿ç”¨vs codeæ‰“å¼€äº†å®ƒï¼Œæˆ‘ä»¬å¯ä»¥åœ¨fpmå·¥ç¨‹çš„`fpm.toml`æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹è¯­å¥ï¼Œä»¥ä½¿ç”¨`fortran-lua53`ï¼š

```toml
[dependencies]
fortran-lua53 = { git = "https://github.com/interkosmos/fortran-lua53.git" }
```

![é”™è¯¯ä¸šåŠ¡](media/lua_false.png)

ä¸Šå›¾ï¼Œæˆ‘ä»¬â€œä¸å°å¿ƒâ€åœ¨ Lua è„šæœ¬ä¸­å†™äº†ä¸€ä¸ªé”™è¯¯çš„`times`å‡½æ•°ï¼ˆç²—å¿ƒçš„ç¨‹åºå‘˜å†™æˆäº†åŠ æ³•å‡½æ•°ï¼‰ï¼Œå¯æ˜¯ç¨‹åºå·²ç»è¿è¡Œäº†ï¼Œå¹¸äºè¿™ä¸ª Bug ä¸ä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼Œæˆ‘ä»¬å¾—èµ¶ç´§ä¿®æ”¹å®ƒï¼Œå¹¶ä¸”å°†è¿™ä¸ªè¡¥ä¸å‘é€ç»™ç”¨æˆ·ã€‚

```sh
 5 * 5 =           10
 æŒ‰å›è½¦ç»§ç»­è¿è¡Œ..
```

![æ­£ç¡®ä¸šåŠ¡](media/lua_true.png)

æˆ‘ä»¬åœ¨ç¨‹åºè¿è¡Œçš„é—´éš™ï¼Œä¿®æ”¹äº†`times`å‡½æ•°çš„ä¸šåŠ¡ï¼Œå¹¶ä¸”æ¨é€ç»™ç”¨æˆ·è¿è¡Œç¯å¢ƒï¼Œæ­¤åç¨‹åºä¸šåŠ¡å¾—åˆ°æ­£å¸¸åˆç†è¿è¡Œã€‚

```sh
 5 * 5 =           25
 æŒ‰å›è½¦ç»§ç»­è¿è¡Œ..
```

æˆ‘ä»¬èƒ½çœ‹åˆ°ï¼ŒLua è„šæœ¬çš„å¼ºå¤§ä¹‹å¤„ï¼Œå°¤å…¶æ˜¯å¯¹å¼ºç¼–è¯‘å‹è¯­è¨€çš„ç‰¹æ®Šéœ€æ±‚ï¼Œå®ƒä½¿å¾—ç¨‹åºå˜å¾—æ›´çµæ´»ï¼Œç›¸å½“äºç”¨æˆ·ä¸šåŠ¡ç¨‹åºå®æ—¶è‡ªå¸¦äº†ä¸€ä¸ªå®æ—¶é«˜æ•ˆçš„ Lua è§£é‡Šå™¨ã€‚

å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™ä¸ªç‰¹æ€§å¸¸è§„ç”¨æˆ·æ˜¯ä¸å¤ªéœ€è¦çš„ï¼Œä½†ç¡®å®ä¸ºç¼–ç¨‹æä¾›äº†ä¸€ç§ç‰¹è‰²å¼ºçƒˆçš„å¯èƒ½æ€§ï¼Œè·¨è¯­è¨€äº¤äº’å’Œçƒ­é‡è½½ã€‚

## ä»£ç 

```fortran
program main
    
    use, intrinsic :: iso_c_binding, only: c_ptr
    use lua
    implicit none
    !> C æŒ‡é’ˆ, å¯ä»¥æŒ‡å‘ä»»ä½•ç±»å‹çš„ C å¯¹è±¡
    type(c_ptr) :: l
    integer :: rc
    
    do
        !> å¯åŠ¨ Lua è™šæ‹Ÿæœº
        l = lual_newstate()
        call lual_openlibs(l)
        rc = lual_dofile(l, "times.lua")
        rc = lua_getglobal(l, "times")
        
        !> æ¨é€å‚æ•°å€¼
        call lua_pushinteger(l, 5)
        call lua_pushinteger(l, 5)
        rc = lua_pcall(l, 2, 1, 0) ! è°ƒç”¨timeså‡½æ•°ï¼Œæ¨é€2ä¸ªå‚æ•°ï¼Œè¿”å›1ä¸ªç»“æœ
        
        !> è·å–è¿”å›å€¼
        rc = lua_tointeger(l, -1) ! -index: ç¬¬å‡ ä¸ªè¿”å›å€¼
        call lua_pop(l, 1)        ! å¼¹å‡ºè¿”å›å€¼åŠå…¶æ•°é‡
        
        print *, "5 * 5 = ", rc
        print *, "æŒ‰å›è½¦ç»§ç»­è¿è¡Œ.."
        read (*, *)
        
    end do
    
end program main
```

```lua
-- æ•´æ•°ä¹˜æ³•
function times(a, b)  
    return a + b
end
```
