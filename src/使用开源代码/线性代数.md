# ä½¿ç”¨OpenBLASè¿›è¡ŒçŸ©é˜µè®¡ç®—

OpenBLASå®˜ç½‘ï¼š[https://www.openblas.net/](https://www.openblas.net/)<br>
BLASç½‘ç«™ï¼š[http://www.netlib.org/blas/#_blas_routines](http://www.netlib.org/blas/#_blas_routines)ğŸ¯

BLASï¼ˆBasic Linear Algebra Subprogramsï¼‰æ˜¯è‘—åçš„åŸºç¡€çº¿æ€§ä»£æ•°åº“ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨è¢«æ·±åº¦ä¼˜åŒ–çš„OpenBLASæ¥è¿›è¡Œçº¿æ€§ä»£æ•°è®¡ç®—ã€‚

BLASåº“ä¸­çš„å‡½æ•°æ“ä½œæ ¹æ®è¿ç®—å¯¹è±¡åˆ†ä¸ºä¸‰ç±»ï¼Œå®ƒä»¬çš„æ—¶é—´å¤æ‚åº¦ä¾æ¬¡é€’å¢ï¼š

- Level 1ï¼šå‘é‡é—´çš„è¿ç®—ï¼ˆ1979å¹´~ï¼‰ï¼›
- Level 2ï¼šçŸ©é˜µä¸å‘é‡çš„è¿ç®—ï¼ˆ1988å¹´~ï¼‰ï¼›
- Level 3ï¼šçŸ©é˜µé—´çš„è¿ç®—ï¼ˆ1990å¹´~ï¼‰ã€‚

<div align="center">
<img src="media/openblas-logo.png" alt="OpenBLAS Logo" width="220">
</div>

## å®‰è£…OpenBLAS

æˆ‘ä»¬ä½¿ç”¨MSYS2è½¯ä»¶èƒ½éå¸¸ä¾¿æ·åœ°å®‰è£…OpenBLASï¼ˆå‡è®¾ä½ å·²ç»å®‰è£…äº†MSYS2ï¼Œå¹¶ä¸”é…ç½®äº†ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼‰ï¼š

```sh
pacman -Ss openblas  # æŸ¥è¯¢åå­—ä¸­å«â€œopenblasâ€å­—ç¬¦çš„åŒ…
pacman -S  ucrt64/mingw-w64-ucrt-x86_64-openblas  # å®‰è£…openblas
```

## Blas/Lapackçš„æ¥å£è¯´æ˜

- å‡½æ•°æˆ–å­ç¨‹åºå‘½åæ ¼å¼ä¸º`ABBCCC` ï¼Œå…¶ä¸­Aè¡¨ç¤ºæ•°æ®ç±»å‹ï¼ŒBBè¡¨ç¤ºçŸ©é˜µç±»å‹ï¼ŒCCCè¡¨ç¤ºè¿ç®—ç±»å‹(ä¸è¶³ä¸‰ä¸ªä¸€èˆ¬å†™CC)ã€‚
- A æœ‰å››ç§(S/D/C/Z)ï¼ŒS è¡¨ç¤ºå•ç²¾åº¦æµ®ç‚¹æ•°`real(4)`ï¼ŒDè¡¨ç¤ºåŒç²¾åº¦æµ®ç‚¹æ•°`real(8)`ï¼ŒCè¡¨ç¤ºå•ç²¾åº¦å¤æ•°`complex(4)`,Zè¡¨ç¤ºåŒç²¾åº¦å¤æ•°`complex(8)`ã€‚
- BB ä¾‹å¦‚ ge/ä¸€èˆ¬çŸ©é˜µï¼Œsy/å¯¹ç§°çŸ©é˜µï¼Œhe/å„å¯†çŸ©é˜µç­‰ç­‰ï¼Œå…¨éƒ¨çš„ç±»å‹å¯ä»¥åœ¨è¯¥ç½‘ç«™æŸ¥æ‰¾ï¼Œ [çŸ©é˜µç±»å‹](https://www.netlib.org/lapack/lug/node24.html)ã€‚
- CCC ä¾‹å¦‚ svd/svdåˆ†è§£ï¼Œmm/çŸ©é˜µç›¸ä¹˜ï¼Œev/ç‰¹å¾å€¼é—®é¢˜ç­‰ç­‰ã€‚
- ç»„åˆèµ·æ¥ï¼Œä¾‹å¦‚ dgemm/(åŒç²¾åº¦ä¸€èˆ¬çŸ©é˜µçš„ä¹˜æ³•)ï¼Œdsyev/(åŒç²¾åº¦å¯¹ç§°çŸ©é˜µçš„ç‰¹å¾å€¼é—®é¢˜)ã€‚å…³äºå…¨éƒ¨æ¥å£çš„æè¿°ï¼Œå‚è€ƒç½‘ç«™ï¼Œ [Blas/Lapackæ¥å£](http://www.netlib.org/lapack/explore-html/modules.html)ã€‚
- è°ƒç”¨æ—¶,æŸ¥çœ‹å¯¹åº”çš„æ¥å£ï¼Œäº†è§£å‡½æ•°æˆ–è€…å­ç¨‹åºçš„è¿”å›å€¼ï¼Œå¡«å†™ä¸ä¹‹å¯¹åº”çš„å‚æ•°ï¼Œäº†è§£æŠ¥é”™æ—¶è¿”å›å€¼çš„å«ä¹‰ã€‚
- ç›®å‰å¹¶ä¸æ”¯æŒå››ç²¾åº¦ï¼Œå¦‚æœéœ€è¦ï¼Œå¯è‡ªè¡Œä¸‹è½½æºä»£ç æ›¿æ¢ç±»å‹ã€‚


## æ¼”ç¤ºï¼šOpenBLASæ±‚è§£çº¿æ€§æ–¹ç¨‹ç»„

```sh
cd workspace  # åˆ‡æ¢åˆ°ä½ å¸¸ç”¨çš„å·¥ä½œåŒºé—´
fpm new --app solve-demo  # åˆ›å»ºfpmé¡¹ç›®
cd solve-demo && code .   # åˆ‡æ¢åˆ°`solve-demo`æ–‡ä»¶å¤¹ï¼Œå¹¶ä½¿ç”¨vs codeæ‰“å¼€å®ƒ
```

ä¸å‡ºæ„å¤–çš„è¯ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª`solve-demo`å·¥ç¨‹ï¼Œå¹¶ä¸”ä½¿ç”¨vs codeæ‰“å¼€äº†å®ƒï¼Œæˆ‘ä»¬åœ¨`fpm.toml`ä¸­æ·»åŠ å£°æ˜æ¥å¼•ç”¨å®‰è£…çš„OpenBLASé“¾æ¥åº“ï¼š

```toml
[build]
link = ["openblas"]
```

![OpenBLASæ¼”ç¤º](media/openblas-demo.png)

é€šè¿‡ä½¿ç”¨åŒç²¾åº¦çš„çº¿æ€§æ–¹ç¨‹ç»„æ±‚è§£ä¾‹ç¨‹`dgesv`ï¼Œæˆ‘ä»¬æ±‚è§£åˆ°äº†é¢„è®¾æ–¹ç¨‹ç»„`Ax = b`çš„æ­£ç¡®ç»“æœğŸš€ï¼š`x = [1.0; 3.0]`ã€‚

> ğŸ”° æç¤ºï¼šè¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„æ¼”ç¤ºï¼Œæ›´å¤šçš„ä¾‹ç¨‹ä½¿ç”¨è¿˜éœ€è¦ç”¨æˆ·è‡ªè¡Œå‰å¾€å®˜æ–¹ç½‘ç«™æŸ¥è¯¢å¸®åŠ©æ–‡æ¡£ã€‚<br>
> åšå·¥ç¨‹ä¸æ˜¯æè‰ºæœ¯ï¼Œè€Œä¸”ç”¨æˆ·æ˜¯è¢«æä¾›æœåŠ¡ä¸€æ–¹ï¼Œä¸è¦è¿‡äºçº ç»“APIæ¥å£çš„ç¾è§‚ä¸å¦ï¼Œå½¢æˆå¯è¡Œçš„è§£å†³æ–¹æ¡ˆå§‹ç»ˆæ˜¯ç¬¬ä¸€è¦ä¹‰ã€‚

### ç¤ºä¾‹ä»£ç 

```fortran
program main

    use, intrinsic :: iso_fortran_env, only: real64
    implicit none
    real(real64) :: A(2, 2), b(2, 1)  !! çº¿æ€§æ–¹ç¨‹ç»„çŸ©é˜µ
    integer :: ipiv(2)  !! openblasä¸­çš„è¡Œåˆ—äº¤æ¢æ ‡è®°ã€å·¥ä½œæ•°ç»„
    integer :: info     !! openblasä¸­çš„è¿”å›å€¼

    A = reshape([1.0, 3.0, 2.0, 4.0], [2, 2])
    b = reshape([7.0, 15.0], [2, 1])

    !> `dgesv`æ±‚è§£åŒç²¾åº¦çº¿æ€§æ–¹ç¨‹ç»„
    call dgesv(2, 1, A, 2, ipiv, b, 2, info)

    !> æœ€ç®€å•çš„æµ‹è¯•
    call check(info == 0, "`info == 0` failed")
    call check(abs(b(1, 1) - 1.0) < 1.0E-6, "`b(1,1) == 1.0` failed")
    call check(abs(b(2, 1) - 3.0) < 1.0E-6, "`b(2,1) == 3.0` failed")

    print *, "ç»“æœç¬¦åˆé¢„æœŸï¼Œæ­£å¸¸é€€å‡º ^_^"
contains

    !> æ–­è¨€ä¸æµ‹è¯•
    subroutine check(condition, msg)
        logical, intent(in) :: condition     !! æµ‹è¯•æ¡ä»¶
        character(len=*), intent(in) :: msg  !! æµ‹è¯•å¤±è´¥æ—¶çš„æ¶ˆæ¯
        if (condition) return
        error stop msg
    end subroutine check

end program main
```
